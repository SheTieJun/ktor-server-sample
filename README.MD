# Server

[ktor-cn](https://ktor.kotlincn.net)
[ktor.io](https://ktor.io/docs/welcome.html)

## å¼€å‘ç¯å¢ƒï¼šWindows

- Android Studio Hedgehog | 2023.1.1 Patch 1 (å› ä¸ºæˆ‘æ˜¯Androidå¼€å‘ï¼Œä¹ æƒ¯äº†ç›¸å…³é…ç½®)
- JDK : Java 17
- Gradle : 8.0
- Docker :Win DockerDesktop+MySql+Redis+(ktor-application)
-
Testï¼šPostman,[æµ‹è¯•æ¡ˆä¾‹](https://dev-jun.postman.co/workspace/Dev1~68c25709-3d9e-4260-897b-a9025e77c641/collection/17982394-68dc2b14-2a73-4d5a-88f1-107c928e0e75?action=share&creator=17982394)

[**MySQLå®‰è£…**](https://www.runoob.com/mysql/mysql-install.html)

[**Rediså®‰è£…**](https://www.runoob.com/docker/docker-install-redis.html)

## å·²å®ç°åŠŸèƒ½

- **Koin**:ä¾èµ–æ³¨å…¥
- **JWT**:è·å–token,éªŒè¯tokenï¼Œåˆ·æ–°token
- **Mysql**:è¿æ¥æ•°æ®åº“ï¼ŒåŸºç¡€åŠŸèƒ½å®ç°
- **Redis**:è¿æ¥redisï¼ŒåŸºç¡€åŠŸèƒ½å®ç°
- **Websocket**:åŸºç¡€åŠŸèƒ½å®ç°
- **HTML**:é™æ€èµ„æºã€ç½‘é¡µè¯·æ±‚ï¼ŒåŸºç¡€åŠŸèƒ½å®ç°
- **API**:æ ‡å‡†æ ¼å¼ç»Ÿä¸€è¿”å›ï¼Œé”™è¯¯codeï¼ŒExceptionéƒ½ç»Ÿä¸€è¿”å›å¼‚å¸¸ï¼Œåç»­å¯ä»¥åŠ å…¥UAåˆ¤æ–­ï¼Œwebè¿”å›ç‰¹å®šhtml,æ‰‹æœºè¿”å›json
- **Log**:logbackæ—¥å¿—è®°å½•
- **Docker**:æ‰“åŒ…åˆ°docker ï¼Œ[Alpine Linux](https://alpinelinux.org/)
- **[rate Limit](https://ktor.io/docs/rate-limit.html)**:ä¸€å®šæ—¶é—´é™åˆ¶å†…api*é™åˆ¶è®¿é—®æ¬¡æ•°

## ä¸»è¦çš„åº“ï¼š

- Ktor ï¼šä¸ªè½»é‡çº§ã€çµæ´»ä¸”å¯æ‰©å±•çš„ Kotlin Web æ¡†æ¶ï¼Œé€‚ç”¨äºæ„å»ºå¼‚æ­¥ã€éé˜»å¡çš„ Web åº”ç”¨ç¨‹åºå’Œ APIã€‚
- Koinï¼šä¾èµ–æ³¨å…¥æ¡†æ¶
- exposed+mysqlï¼šexposedä¸€ä¸ªç”¨äº Kotlin çš„è½»é‡çº§ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œç”¨äºä¸å…³ç³»å‹æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäºç±»å‹å®‰å…¨çš„ DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰ï¼Œä½¿å¾—æ•°æ®åº“æ“ä½œå˜å¾—ç®€å•è€Œç›´è§‚ã€‚
- jedis:ä¸€ä¸ªç”¨äº Java çš„æµè¡Œçš„ Redis å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸ Redis æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚
- gson:ä¸€ä¸ªç”¨äºåœ¨ Java å¯¹è±¡å’Œ JSON æ•°æ®ä¹‹é—´è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¼€æºåº“ã€‚

```groovy
def ktor_version = "2.3.7"
api platform("io.ktor:ktor-bom:$ktor_version")
def kotlin_version = "1.9.22"
def logback_version = "1.4.11"

implementation("io.ktor:ktor-server-auth-jvm") //æƒé™åˆ¤æ–­
implementation("io.ktor:ktor-server-core-jvm")
implementation("io.ktor:ktor-server-auth-jwt-jvm") //jwt
implementation("io.ktor:ktor-server-websockets-jvm") //websocket
implementation("io.ktor:ktor-server-html-builder-jvm")//DSLæ„å»ºhtml
implementation("io.ktor:ktor-server-content-negotiation-jvm")
implementation("io.ktor:ktor-serialization-gson-jvm") //jsonåºåˆ—è¯
implementation("io.ktor:ktor-server-netty-jvm") //netty
implementation("io.ktor:ktor-server-status-pages") //é”™è¯¯é¡µé¢
implementation("io.ktor:ktor-server-call-logging")//æ—¥å¿—
implementation("io.ktor:ktor-server-swagger-jvm")//swagger
implementation("io.ktor:ktor-server-cors")//è·¨åŸŸ
implementation("io.ktor:ktor-client-cio") //å®¢æˆ·ç«¯ï¼Œç”¨æ¥è¯·æ±‚å…¶ä»–æœåŠ¡
implementation("io.ktor:ktor-server-rate-limit")//é™æµ
implementation("ch.qos.logback:logback-classic:$logback_version")
testImplementation("io.ktor:ktor-server-tests-jvm")
testImplementation("org.jetbrains.kotlin:kotlin-test-junit:$kotlin_version")

//æ•°æ®åº“ https://github.com/JetBrains/Exposed
def exposed_version = "0.46.0"
def mysql_version = "8.0.33"
implementation("org.jetbrains.exposed:exposed-core:$exposed_version")
implementation("org.jetbrains.exposed:exposed-dao:$exposed_version")
implementation("org.jetbrains.exposed:exposed-jdbc:$exposed_version")
implementation("org.jetbrains.exposed:exposed-java-time:$exposed_version")
implementation("mysql:mysql-connector-java:$mysql_version") //mysql jdbc

//ä¾èµ–å€’ç½®
// https://mvnrepository.com/artifact/io.insert-koin/koin-ktor
implementation("io.insert-koin:koin-ktor:3.5.3") //ä¾èµ–æ³¨å…¥

// https://mvnrepository.com/artifact/redis.clients/jedis
implementation("redis.clients:jedis:5.1.0") //redis

```

## é‡åˆ°çš„é—®é¢˜

<aside>
ğŸ’¡ java.sql.SQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
</aside>

å¯¼è‡´çš„åŸå› ï¼šæˆ‘çš„dockeræ˜¯è¿è¡Œåœ¨WSLä¸Šçš„ï¼ŒMysqlå’ŒRediséƒ½æ˜¯ï¼Œç›´æ¥ç”¨127.0.0.1çš„æ—¶å€™æœ¬åœ°è°ƒè¯•æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å…¨éƒ¨æ”¾åˆ°dockerä¸Šçš„æ—¶å€™å°±æœ‰é—®é¢˜äº†

## éƒ¨åˆ†å®ç°åŸç†

### 1. æ ‡å‡†æ ¼å¼ç»Ÿä¸€è¿”å›ï¼Œä¿å­˜é”™è¯¯codeï¼ŒExceptionéƒ½ç»Ÿä¸€è¿”å›å¼‚å¸¸

æ·»åŠ æ’ä»¶ï¼š[status pages](https://ktor.io/docs/status-pages.html)

```groovy
implementation("io.ktor:ktor-server-status-pages") //é”™è¯¯é¡µé¢
```

ä»£ç å®ç°å¦‚ä¸‹

```kotlin
install(StatusPages) {
    HttpStatusCode.allStatusCodes.forEach {
        if (it == HttpStatusCode.OK
            || it == HttpStatusCode.TooManyRequests
            || it == HttpStatusCode.MethodNotAllowed
            || it == HttpStatusCode.NotFound
        ) {
            return@forEach
        }
        if (it.value in 400..599) { //åªå¤„ç†é”™è¯¯çš„çŠ¶æ€ç 
            status(it) { call, _ ->
                call.jsonError(it.value, "${it.value}: ${it.description}")
            }
            return@forEach
        }
    }
}
```

æ¡ˆä¾‹ï¼š

```json
{
  "code": 404,
  "msg": "method /userinfoxx not found"
}
```

### 2. [JWTå®ç°](doc/JWT%E5%AE%9E%E7%8E%B0.MD):ç›¸å…³æ–‡æ¡£[JSON Web Tokens](https://ktor.io/docs/3.0.0-beta-1/jwt.html)

### 3. æ¥å£é™åˆ¶ï¼š[rate-limit](https://ktor.io/docs/rate-limit.html)

